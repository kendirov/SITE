# Логика бота Eatventure — простым языком

Этот файл описывает **что делает бот**, **в каком порядке** и **что происходит, если что-то нашли или не нашли**. Всё максимально просто, без технического жаргона.

---

## Что это за проект

Бот для игры **Eatventure**: он смотрит в экран (в зону игры), ищет на ней кнопки и другие элементы по картинкам-образцам и нажимает на них. То есть автоматизирует рутину: апгрейды, сбор монет, переход на новый уровень и т.д.

**Запуск:** из корня проекта команда `python run.py`. Остановка — клавиша **ESC** (аварийное выключение).

---

## Общий цикл работы

Бот крутит **один и тот же цикл** без остановки. В каждом проходе он по очереди проверяет несколько «задач». Как только одна задача что-то сделала — цикл сразу начинается заново (с первой задачи). Если ни одна задача ничего не сделала — бот пишет «IDLE» и ждёт 1 секунду, потом снова проверяет с начала.

**Порядок задач (приоритет):**

1. Ремонт/перелёт (Renovator)
2. Общие апгрейды (General Upgrades)
3. Апгрейды станций (Station Upgrader)
4. Прокрутка экрана (Navigator)
5. Сбор чаевых (Tips)
6. Сбор сундуков (Boxes)
7. Если ничего не сделали — Idle (пауза 1 сек)

Ниже — по шагам: **что ищем**, **что делаем, если нашли**, **что делаем, если не нашли**.

---

## 1. Ремонт и перелёт (Renovator)

**Зачем:** закрыть всплывающие окна, нажать «Ремонт ресторана» или «Перелёт в новый город», подтвердить действие.

### Что ищем и в каком порядке

- **Кнопку «Okay»** — если есть всплывающее окно с ней.
- **Кнопку «Open»** (открыть уровень) — если игра предлагает открыть уровень.
- **Кнопку «Ремонт» (молоток)** или **«Перелёт» (самолёт)** — чтобы перейти на следующий этап.
- После нажатия на ремонт/перелёт — **кнопку подтверждения**: «Перелёт» (fly confirm) или «Подтвердить ремонт» (confirm renovate).

### Если нашли

- **Okay** — кликаем, ждём 1 сек, выходим из цикла (цикл начнётся заново).
- **Open** — кликаем, ждём 3 сек, выходим.
- **Ремонт или Перелёт** — кликаем, ждём 2 сек. Потом ищем кнопку подтверждения:
  - Если нашли **«Подтвердить перелёт»** — кликаем, ждём 10 сек, потом снова ищем «Okay» и кликаем, если есть.
  - Если нашли **«Подтвердить ремонт»** — кликаем, ждём 6 сек.
- После любого из этих действий — выходим из цикла (return True).

### Если не нашли

- Не нашли ни Okay, ни Open, ни Ремонт/Перелёт — выходим из этой задачи (return False), бот переходит к следующей задаче (General Upgrades).

---

## 2. Общие апгрейды (General Upgrades)

**Зачем:** открыть меню апгрейдов повара, быстро докупить самый верхний апгрейд (синяя кнопка), закрыть меню.

### Ограничение

- Меню апгрейдов не открываем чаще чем раз в **30 секунд** (cooldown). Если с последнего открытия прошло меньше 30 сек — сразу выходим (ничего не ищем).

### Что ищем

- **Иконку апгрейдов** (icon_upgrades) — чтобы открыть меню.

### Если нашли

- Запоминаем время открытия меню.
- Кликаем по иконке, ждём 0.5 сек.
- Ищем **все синие кнопки** (blue_button) в меню. Берём **самую верхнюю** (минимальная координата Y).
- По этой кнопке делаем **до 15 быстрых кликов** подряд (с паузой 0.02 сек) — «турбо-покупка».
- Потом закрываем меню: ищем **крестик** (btn_close_x). Если нашли — кликаем по нему; если нет — кликаем в точку (200, 150) как «выход».
- Ждём ещё чуть-чуть. Выходим из цикла (return True).

### Если не нашли

- Не нашли иконку апгрейдов (или ещё не прошло 30 сек) — выходим из задачи (return False), бот переходит к апгрейдам станций.

---

## 3. Апгрейды станций (Station Upgrader)

**Зачем:** улучшать станции (прилавки) в ресторане: находим стрелку апгрейда, открываем станцию, держим кнопку «Купить», закрываем меню.

### Ограничения

- **«Счётчик подряд»:** если мы уже **3 раза подряд** успешно прокачали станцию, бот специально выходит из этой задачи (return False), чтобы дать сработать **Navigator** (прокрутке). Так мы не залипаем на одном месте.
- Для каждой станции есть **cooldown 20 сек**: повторно кликать по той же станции (в радиусе 30 пикселей) можно только через 20 сек.

### Что ищем

- **Все стрелки апгрейда** (upgrade_arrow) на экране.

### Если нашли стрелки

- Отбрасываем те стрелки, по которым ещё действует cooldown.
- Из оставшихся берём **самую верхнюю** (минимальный Y).
- По координатам стрелки считаем точку клика для открытия станции (стрелка + смещение из конфига: STATION_OFFSET_X, STATION_OFFSET_Y).
- Кликаем **точно** в эту точку (открываем меню станции), ждём MENU_OPEN_DELAY (0.5 сек).
- Ищем **кнопку «Купить»** (btn_buy):
  - **Если нашли** — считаем центр кнопки и делаем **долгий клик** (удерживаем 3 сек) по центру.
  - **Если не нашли** — пишем в лог, что кнопки нет (нет денег или глюк).
- Закрываем меню станции: кликаем **точно** в ту же точку, что открывали (click_exact).
- Запоминаем эту станцию в cooldown на 20 сек, увеличиваем «счётчик подряд» на 1, выходим (return True).

### Если не нашли

- Стрелок нет, или все отфильтрованы по cooldown — сбрасываем «счётчик подряд» в 0, выходим (return False). Переходим к Navigator.

---

## 4. Прокрутка экрана (Navigator)

**Зачем:** листать экран вниз, чтобы на экране появлялись новые станции и объекты. Но если упёрлись в «стену» (конец уровня) — чуть откатываем свайп назад.

### Что делаем

- Запоминаем **кадр до прокрутки** (скриншот зоны игры).
- Делаем **свайп вниз** (на самом деле двигаем палец вверх по экрану, чтобы контент поехал вниз): от точки (70% высоты зоны) к точке (40% высоты), по центру по X.
- Ждём 1.2 сек.
- Делаем **кадр после прокрутки**.

### Анализ

- Сравниваем два кадра (средний квадрат разницы пикселей). Если разница **меньше порога** (800) — считаем, что это **«стена»**: экран почти не изменился, мы в конце.
  - **Если стена:** делаем небольшой **откат свайпа** назад (pull back), выходим (return False).
  - **Если не стена:** считаем прокрутку успешной, выходим (return True).

### Если что-то пошло не так

- Не удалось сделать скриншот — выходим (return False). Бот перейдёт к сбору чаевых.

---

## 5. Сбор чаевых (Tips)

**Зачем:** собирать монетки-чаевые, которые лежат на столах (tip_coin).

### Ограничение

- Собирать чаевые не чаще чем раз в **15 секунд** (TIPS_COOLDOWN). Если не прошло — выходим, ничего не ищем.

### Что ищем

- **Все монетки чаевых** (tip_coin) на экране.

### Если нашли

- Берём **первые 5** монеток. По каждой кликаем в центр, с маленькой паузой 0.05 сек.
- Запоминаем время сбора, включаем cooldown 15 сек. Выходим (return True).

### Если не нашли

- Монеток нет (или cooldown ещё не прошёл) — выходим (return False). Переходим к сбору сундуков.

---

## 6. Сбор сундуков (Boxes)

**Зачем:** подбирать сундуки (box_floor), которые лежат на полу. За один проход — не больше 3 штук, чтобы не спамить во время анимации открытия.

### Ограничение

- Сундуки собираем не чаще чем раз в **10 секунд** (BOX_COOLDOWN).

### Что ищем

- **Все сундуки на полу** (box_floor).

### Если нашли

- Берём **первые 3** сундука. По каждому кликаем (передаём прямоугольник в click_element — клик в центр), пауза 0.1 сек.
- Запоминаем время, включаем cooldown 10 сек. Выходим (return True).

### Если не нашли

- Сундуков нет (или cooldown не прошёл) — выходим (return False). Бот переходит к Idle.

---

## 7. Idle (ожидание)

**Когда:** все шесть задач выше в этом проходе цикла ничего не сделали (все вернули False).

**Что делаем:** пишем в лог «IDLE: No actions available», ждём **1 секунду**, затем цикл повторяется с начала (снова Renovator → General → Station → Navigator → Tips → Boxes).

---

## Как бот «видит» экран (Vision)

- Берётся **не весь экран**, а только **зона игры** — прямоугольник **GAME_REGION** из конфига (по умолчанию (0, 0, 500, 900)). Это левый верхний угол (x, y) и размер (ширина, высота) в логических пикселях.
- Делается **скриншот только этой зоны** (через mss). Так бот не путается с другими окнами и панелями.
- По скриншоту ищутся **картинки-образцы** из папки **assets**: например `btn_buy.png`, `blue_button.png`, `upgrade_arrow.png` и т.д.
- Поиск идёт через **шаблонное сравнение** (OpenCV): картинка образца прикладывается к кадру в разных масштабах (0.5, 1.0, 2.0). Если совпадение выше порога (CONFIDENCE_THRESHOLD, обычно 0.7) — считаем, что нашли.
- Координаты пересчитываются в **логические пиксели** (учёт Retina и т.п.), чтобы клики попадали в нужное место.
- **find_image** — ищет один лучший совпадение, возвращает (x, y, w, h) или None.
- **find_all_images** — ищет все совпадения выше порога, возвращает список (x, y, w, h).
- Если совпадения нет — в debug может сохраняться скриншот с пометкой «low_confidence_…», чтобы потом понять, почему не нашли.

---

## Как бот «нажимает» (Input)

- **Обычный клик (click_element):** по переданным координатам (или по центру переданного прямоугольника) считается точка; к ней добавляется **небольшой случайный сдвиг** (до CLICK_OFFSET_MAX пикселей), чтобы клик выглядел более «человечно». Затем один клик мыши.
- **Точный клик (click_exact):** без сдвига, ровно в (x, y). Нужен там, где важно попасть в одну и ту же точку (например, открыть/закрыть меню станции).
- **Долгий клик (long_click):** мышь опускается в (x, y), держится заданное время (например 3 сек), затем отпускается. Используется для кнопки «Купить» на станции.
- **Свайп (swipe):** движение от (x1, y1) к (x2, y2) за заданное время. Используется в Navigator для прокрутки и отката.

Все координаты — в **логических пикселях**, как отдаёт Vision.

---

## Настройки (Config) — что можно менять

- **GAME_REGION** — зона экрана, где игра (x, y, ширина, высота). От неё зависят и скриншот, и все координаты поиска.
- **ASSETS_PATH** — папка с картинками-образцами (кнопки, иконки, стрелки, монетки, сундуки).
- **CONFIDENCE_THRESHOLD** — минимальная «уверенность» совпадения шаблона (0.7 по умолчанию).
- **STATION_COOLDOWN**, **TIPS_COOLDOWN**, **MENU_OPEN_DELAY**, **HOLD_DURATION** — таймеры и задержки для станций, чаевых, меню и удержания кнопки.
- **STATION_OFFSET_X / STATION_OFFSET_Y** — смещение от стрелки апгрейда до точки клика по станции.
- **CLICK_OFFSET_MAX** — максимальный случайный сдвиг клика в пикселях.

---

## Картинки-образцы (assets), которые мы ищем

| Имя файла | Где используется |
|-----------|------------------|
| btn_okay | Renovator — закрытие всплывающих окон |
| btn_open_level | Renovator — открыть уровень |
| btn_renovate | Renovator — кнопка ремонта (молоток) |
| btn_fly | Renovator — кнопка перелёта (самолёт) |
| btn_fly_confirm | Renovator — подтвердить перелёт |
| btn_confirm_renovate | Renovator — подтвердить ремонт |
| icon_upgrades | General Upgrades — иконка меню апгрейдов |
| blue_button | General Upgrades — кнопки покупки в меню |
| btn_close_x | General Upgrades — закрыть меню (крестик) |
| upgrade_arrow | Station Upgrader — стрелка у станции |
| btn_buy | Station Upgrader — кнопка «Купить» в меню станции |
| tip_coin | Tips — монетка чаевых |
| box_floor | Boxes — сундук на полу |

Остальные файлы в assets могут использоваться в других скриптах или про запас.

---

## Краткая схема «что за чем»

1. **Ремонт/перелёт** — закрыть окна, нажать ремонт или перелёт, подтвердить.  
2. **Общие апгрейды** — раз в 30 сек открыть меню, турбо-кликать по верхней синей кнопке, закрыть.  
3. **Станции** — найти стрелку без cooldown, открыть станцию, держать «Купить», закрыть; после 3 успехов подряд — уйти в прокрутку.  
4. **Прокрутка** — свайп вниз; если стена — откат и выход.  
5. **Чаевые** — раз в 15 сек собрать до 5 монеток.  
6. **Сундуки** — раз в 10 сек подобрать до 3 сундуков.  
7. **Ничего не делать** — пауза 1 сек и снова с пункта 1.

Вся логика бота укладывается в этот цикл и эти семь шагов.
