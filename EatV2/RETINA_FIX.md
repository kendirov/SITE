# üîç RETINA –î–ò–°–ü–õ–ï–ô FIX - Multi-Scale Template Matching

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê:

–ë–æ—Ç –Ω–∞—Ö–æ–¥–∏—Ç `tip_coin`, –Ω–æ **–ù–ï –Ω–∞—Ö–æ–¥–∏—Ç** `upgrade_arrow`, `btn_renovate`, `icon_upgrades`.

### –ü—Ä–∏—á–∏–Ω–∞: **Retina Display (MacBook Air)**

–ù–∞ Retina –¥–∏—Å–ø–ª–µ—è—Ö:
- **–°–∫—Ä–∏–Ω—à–æ—Ç—ã Mac** (Cmd+Shift+4): 2x —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (Retina)
- **mss –∑–∞—Ö–≤–∞—Ç**: 1x —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–∏–∫—Å–µ–ª–∏)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–®–∞–±–ª–æ–Ω upgrade_arrow.png: 100x100 pixels (Retina —Å–∫—Ä–∏–Ω—à–æ—Ç)
–≠–∫—Ä–∞–Ω mss:                50x50 pixels  (—Ä–µ–∞–ª—å–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞)

cv2.matchTemplate ‚Üí –ù–ï –ù–ê–•–û–î–ò–¢! (—Ä–∞–∑–º–µ—Ä—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç)
```

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï: Multi-Scale Template Matching

### –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ:

#### 1. `config.py` - –ù–æ–≤—ã–µ –º–∞—Å—à—Ç–∞–±—ã
```python
VISION_SCALES = (0.5, 0.6, 0.75, 0.9, 1.0, 1.1, 1.25, 1.5, 2.0)

# 0.5  - –µ—Å–ª–∏ —à–∞–±–ª–æ–Ω 2x (Retina —Å–∫—Ä–∏–Ω—à–æ—Ç) ‚Üê –ö–†–ò–¢–ò–ß–ù–û!
# 1.0  - –µ—Å–ª–∏ —à–∞–±–ª–æ–Ω —Ç–æ—á–Ω—ã–π —Ä–∞–∑–º–µ—Ä
# 2.0  - –µ—Å–ª–∏ —ç–∫—Ä–∞–Ω 2x (—Ä–µ–¥–∫–æ)
```

**–ë—ã–ª–æ:** `(0.9, 1.0, 1.1)` - —Å–ª–∏—à–∫–æ–º —É–∑–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω  
**–°—Ç–∞–ª–æ:** `(0.5 ... 2.0)` - –ø–æ–∫—Ä—ã–≤–∞–µ—Ç Retina + –æ–±—ã—á–Ω—ã–µ –¥–∏—Å–ø–ª–µ–∏

#### 2. `core/vision.py` - –£–ª—É—á—à–µ–Ω multi-scale

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ (skip if template > screenshot)
- Try-except –¥–ª—è cv2.error
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ª—É—á—à–µ–≥–æ –º–∞—Å—à—Ç–∞–±–∞
- Multi-scale –¥–ª—è `find_all_templates` (–±—ã–ª–æ —Ç–æ–ª—å–∫–æ single scale!)

**–ì–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:**
```python
# –°—Ç–∞—Ä—ã–π –∫–æ–¥:
scales = (0.9, 1.0, 1.1)  # –£–∑–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω

# –ù–æ–≤—ã–π –∫–æ–¥:
scales = config.VISION_SCALES  # (0.5 ... 2.0)
```

#### 3. `debug_vision.py` - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–ù–û–í–´–ô!)

–°–∫—Ä–∏–ø—Ç –∫–æ—Ç–æ—Ä—ã–π:
1. –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–≥—Ä—ã
2. –¢–µ—Å—Ç–∏—Ä—É–µ—Ç **–í–°–ï** —à–∞–±–ª–æ–Ω—ã –∏–∑ `assets/`
3. –ü—Ä–æ–±—É–µ—Ç **–í–°–ï** –º–∞—Å—à—Ç–∞–±—ã (0.5 - 2.0)
4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç **–ª—É—á—à–∏–π confidence –∏ scale** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç `debug_output.png` —Å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞–º–∏

---

## üöÄ –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:

### –®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É

```bash
cd /Users/kendirov/App/EatV2
python3 debug_vision.py
```

### –®–∞–≥ 2: –°–º–æ—Ç—Ä–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

```
üì¶ upgrade_arrow.png
   –†–∞–∑–º–µ—Ä —à–∞–±–ª–æ–Ω–∞: 100x100 pixels
   –ü–æ—Ä–æ–≥: 0.72
   –¢–µ—Å—Ç–∏—Ä—É—é 9 –º–∞—Å—à—Ç–∞–±–æ–≤...
   
   üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ø–æ –º–∞—Å—à—Ç–∞–±–∞–º:
      ‚úÖ Scale 0.50: confidence 0.8543
      ‚ùå Scale 1.00: confidence 0.4231
      ‚ùå Scale 2.00: confidence 0.2134
   
   ‚úÖ –ù–ê–ô–î–ï–ù–û!
      –õ—É—á—à–∏–π scale: 0.50
      Confidence: 0.8543 (–ø–æ—Ä–æ–≥: 0.72)
```

### –®–∞–≥ 3: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π

–û—Ç–∫—Ä–æ–π `debug_output.png` - —É–≤–∏–¥–∏—à—å:
- **–ó–µ–ª–µ–Ω—ã–µ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏** - –Ω–∞–π–¥–µ–Ω–æ (confidence >= threshold)
- **–ñ–µ–ª—Ç—ã–µ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏** - –Ω–∞–π–¥–µ–Ω–æ, –Ω–æ confidence –Ω–∏–∑–∫–∏–π
- **–ù–µ—Ç –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞** - –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤–æ–æ–±—â–µ

---

## üìä –ß–¢–û –û–ñ–ò–î–ê–¢–¨:

### –ï—Å–ª–∏ Retina –¥–∏—Å–ø–ª–µ–π:

```
üìä –ê–ù–ê–õ–ò–ó –ú–ê–°–®–¢–ê–ë–û–í:
   –ù–∞–π–¥–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –ø–æ –º–∞—Å—à—Ç–∞–±–∞–º:
      Scale 0.50x: 8 —à–∞–±–ª–æ–Ω–æ–≤
      Scale 1.00x: 2 —à–∞–±–ª–æ–Ω–∞
      
   ‚ö†Ô∏è  –û–ë–ù–ê–†–£–ñ–ï–ù RETINA –î–ò–°–ü–õ–ï–ô!
      –®–∞–±–ª–æ–Ω—ã –Ω–∞–π–¥–µ–Ω—ã –Ω–∞ –º–∞—Å—à—Ç–∞–±–µ 0.5x
      –≠—Ç–æ –∑–Ω–∞—á–∏—Ç —á—Ç–æ —à–∞–±–ª–æ–Ω—ã 2x —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
      Multi-scale matching –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è —Ç–≤–æ–µ–π —Å–∏—Å—Ç–µ–º—ã!
```

### –ï—Å–ª–∏ –æ–±—ã—á–Ω—ã–π –¥–∏—Å–ø–ª–µ–π:

```
üìä –ê–ù–ê–õ–ò–ó –ú–ê–°–®–¢–ê–ë–û–í:
   –ù–∞–π–¥–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –ø–æ –º–∞—Å—à—Ç–∞–±–∞–º:
      Scale 1.00x: 10 —à–∞–±–ª–æ–Ω–æ–≤
      
   ‚úÖ –ù–æ—Ä–º–∞–ª—å–Ω—ã–π –¥–∏—Å–ø–ª–µ–π (—à–∞–±–ª–æ–Ω—ã —Ç–æ—á–Ω—ã–π —Ä–∞–∑–º–µ—Ä)
```

---

## üîß –ï–°–õ–ò –®–ê–ë–õ–û–ù–´ –í–°–Å –ï–©–Å –ù–ï –ù–ê–•–û–î–Ø–¢–°–Ø:

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ù–∏–∑–∫–∏–π confidence

```
‚ö†Ô∏è  –ü–†–û–ë–õ–ï–ú–ù–´–ï –®–ê–ë–õ–û–ù–´:
   - upgrade_arrow: confidence 0.6543 (–ø–æ—Ä–æ–≥ 0.72, scale 0.50)
     üí° –£–º–µ–Ω—å—à–∏ –ø–æ—Ä–æ–≥ –¥–æ 0.59
```

**–†–µ—à–µ–Ω–∏–µ:** –í `config.py`:
```python
THRESHOLDS = {
    "upgrade_arrow": 0.59,  # –ë—ã–ª–æ 0.72
}
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ

```
   - btn_renovate: –≤–æ–æ–±—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ)
```

**–†–µ—à–µ–Ω–∏–µ:** 
- –°–∫—Ä–æ–ª–ª–Ω–∏ –∏–≥—Ä—É —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ –≤–∏–¥–Ω–∞
- –ó–∞–ø—É—Å—Ç–∏ `debug_vision.py` —Å–Ω–æ–≤–∞

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ü–ª–æ—Ö–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —à–∞–±–ª–æ–Ω–∞

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–¥–∞–ª–∏ —Å—Ç–∞—Ä—ã–π —à–∞–±–ª–æ–Ω –∏–∑ `assets/`
2. –°–¥–µ–ª–∞–π –ù–û–í–´–ô —Å–∫—Ä–∏–Ω—à–æ—Ç —ç–ª–µ–º–µ–Ω—Ç–∞
3. –ò—Å–ø–æ–ª—å–∑—É–π **–æ–±—ã—á–Ω—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç** (–Ω–µ Retina –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
4. –ò–ª–∏ —É–º–µ–Ω—å—à–∏ —Ä–∞–∑–º–µ—Ä –≤ 2 —Ä–∞–∑–∞: `convert template.png -resize 50% template_fixed.png`

---

## üìù –õ–û–ì–ò –í –ë–û–¢–ï:

### –° –Ω–æ–≤—ã–º multi-scale:

```
DEBUG| core.vision | Best match: scale=0.50, confidence=0.85
INFO | StationUpgrader | üéØ –ù–∞–π–¥–µ–Ω–æ 3 —Å—Ç—Ä–µ–ª–æ–∫ –∞–ø–≥—Ä–µ–π–¥–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ!
```

### –°—Ç–∞—Ä—ã–π –∫–æ–¥ (–Ω–µ –Ω–∞—Ö–æ–¥–∏–ª):

```
DEBUG| StationUpgrader | üîç StationUpgrader: –ò—â—É upgrade_arrow...
DEBUG| StationUpgrader | ‚ùå upgrade_arrow –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
```

---

## ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò:

### config.py - –ú–∞—Å—à—Ç–∞–±—ã

```python
# –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ:
VISION_SCALES = (0.5, 0.75, 1.0, 1.5, 2.0)  # –ú–µ–Ω—å—à–µ –º–∞—Å—à—Ç–∞–±–æ–≤ = –±—ã—Å—Ç—Ä–µ–µ

# –î–ª—è Retina –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ:
VISION_SCALES = (0.5, 1.0)

# –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –¥–∏—Å–ø–ª–µ—è:
VISION_SCALES = (0.9, 1.0, 1.1)
```

### config.py - –ü–æ—Ä–æ–≥–∏

```python
THRESHOLDS = {
    "upgrade_arrow": 0.65,  # –£–º–µ–Ω—å—à–∏ –µ—Å–ª–∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç
    "icon_upgrades": 0.65,
    "btn_buy": 0.85,        # –≠—Ç–æ—Ç –ù–ï —É–º–µ–Ω—å—à–∞–π! (–∫—Ä–∏—Ç–∏—á–Ω–æ)
}
```

---

## üéØ –ß–ï–ö–õ–ò–°–¢ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò:

- [ ] –ó–∞–ø—É—Å—Ç–∏–ª `python3 debug_vision.py`
- [ ] –û—Ç–∫—Ä—ã–ª `debug_output.png`
- [ ] –ü–æ—Å–º–æ—Ç—Ä–µ–ª –∫–∞–∫–∏–µ scale —Ä–∞–±–æ—Ç–∞—é—Ç (0.5 = Retina)
- [ ] –ï—Å–ª–∏ confidence –Ω–∏–∑–∫–∏–π ‚Üí —É–º–µ–Ω—å—à–∏–ª –ø–æ—Ä–æ–≥–∏
- [ ] –ï—Å–ª–∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –≤–æ–æ–±—â–µ ‚Üí —Å–¥–µ–ª–∞–ª –Ω–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã
- [ ] –ó–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏–ª —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏

---

## üìö –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò:

### –ü–æ—á–µ–º—É Retina –ø—Ä–æ–±–ª–µ–º–∞?

```
macOS Screenshot API (Cmd+Shift+4):
- –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤ Retina —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏ (2x)
- upgrade_arrow.png = 100x100 pixels

mss library (Python):
- –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–∏–∫—Å–µ–ª–∏ (1x)
- –†–µ–∞–ª—å–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ = 50x50 pixels

cv2.matchTemplate:
- –ò—â–µ—Ç 100x100 –≤ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ –≥–¥–µ —Å—Ç—Ä–µ–ª–∫–∞ 50x50
- –ù–ï –ù–ê–•–û–î–ò–¢!

Multi-Scale Solution:
- –ü—Ä–æ–±—É–µ—Ç template –Ω–∞ scale 0.5 ‚Üí 50x50
- –ù–ê–•–û–î–ò–¢! confidence 0.85
```

### –ü–æ—á–µ–º—É tip_coin —Ä–∞–±–æ—Ç–∞–ª?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
1. –°–ª—É—á–∞–π–Ω–æ —Ç–æ—á–Ω—ã–π —Ä–∞–∑–º–µ—Ä
2. –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π pattern (–∫—Ä—É–≥)
3. –í—ã—Å–æ–∫–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç
4. –ë—ã–ª —Å–¥–µ–ª–∞–Ω –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢:

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
üîç StationUpgrader: –ò—â—É upgrade_arrow...
‚ùå upgrade_arrow –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
üí§ –ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π - –æ—Ç–¥—ã—Ö–∞—é 1 —Å–µ–∫—É–Ω–¥—É...
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
üîç StationUpgrader: –ò—â—É upgrade_arrow...
DEBUG| Vision: Best match: scale=0.50, confidence=0.85
üéØ –ù–∞–π–¥–µ–Ω–æ 3 —Å—Ç—Ä–µ–ª–æ–∫ –∞–ø–≥—Ä–µ–π–¥–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ!
üè™ –ê–ø–≥—Ä–µ–π–∂—É —Å—Ç–∞–Ω—Ü–∏—é –≤ –ø–æ–∑–∏—Ü–∏–∏ (125, 425)
  1Ô∏è‚É£  –ö–ª–∏–∫–∞—é —Å—Ç—Ä–µ–ª–∫—É (–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫)...
  2Ô∏è‚É£  –ò—â—É –∫–Ω–æ–ø–∫—É BUY (–ø–æ—Ä–æ–≥ 0.85)...
  3Ô∏è‚É£  üí∞ –ö–Ω–æ–ø–∫–∞ BUY –Ω–∞–π–¥–µ–Ω–∞ - –∑–∞–∂–∏–º–∞—é 3 —Å–µ–∫—É–Ω–¥—ã...
‚úÖ –ê–ø–≥—Ä–µ–π–¥ –∑–∞–≤–µ—Ä—à–µ–Ω
```

---

## üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢:

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
python3 debug_vision.py

# 2. –û—Ç–∫—Ä–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
open debug_output.png

# 3. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ - —É–º–µ–Ω—å—à–∏ –ø–æ—Ä–æ–≥–∏ –≤ config.py

# 4. –ó–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞
python3 run.py
```

**–¢–µ–ø–µ—Ä—å –±–æ—Ç –Ω–∞–π–¥–µ—Ç –í–°–ï —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ Retina –¥–∏—Å–ø–ª–µ–µ! üéâ**
