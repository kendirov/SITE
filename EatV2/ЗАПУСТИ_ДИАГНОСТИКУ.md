# 🔍 ЗАПУСТИ ДИАГНОСТИКУ!

## 🎯 ПРОБЛЕМА:

Бот находит `tip_coin`, но **НЕ находит** `upgrade_arrow`, `icon_upgrades`, `btn_renovate`.

**Причина:** Retina дисплей (MacBook Air) - шаблоны 2x размер экрана!

---

## ✅ РЕШЕНИЕ ГОТОВО:

1. ✅ Multi-Scale Template Matching (0.5 - 2.0x)
2. ✅ Диагностический скрипт `debug_vision.py`
3. ✅ Детальное логирование

---

## 🚀 ЧТО ДЕЛАТЬ СЕЙЧАС:

### Шаг 1: Запусти диагностику (30 секунд)

```bash
cd /Users/kendirov/App/EatV2
python3 debug_vision.py
```

### Шаг 2: Смотри результаты в терминале

Ты увидишь для **КАЖДОГО** шаблона:

```
📦 upgrade_arrow.png
   Размер шаблона: 100x100 pixels
   Порог: 0.72
   
   📊 РЕЗУЛЬТАТЫ по масштабам:
      ✅ Scale 0.50: confidence 0.8543  ← НАШЛО НА 0.5x!
      ❌ Scale 1.00: confidence 0.4231
      ❌ Scale 2.00: confidence 0.2134
   
   ✅ НАЙДЕНО!
      Лучший scale: 0.50
      Confidence: 0.8543 (порог: 0.72)
```

Или:

```
📦 btn_renovate.png
   
   ⚠️  НАЙДЕНО, но confidence НИЖЕ порога
      Лучший scale: 0.50
      Confidence: 0.6543 (порог: 0.72)
      💡 Попробуй уменьшить порог до 0.59
```

### Шаг 3: Открой `debug_output.png`

```bash
open debug_output.png
```

Увидишь:
- **Зеленые прямоугольники** ✅ - найдено
- **Желтые прямоугольники** ⚠️ - найдено, но низкий confidence
- **Нет прямоугольника** ❌ - не найдено

### Шаг 4: Если нужно - уменьши пороги

В терминале увидишь:

```
⚠️  ПРОБЛЕМНЫЕ ШАБЛОНЫ:
   - upgrade_arrow: confidence 0.6543 (порог 0.72, scale 0.50)
     💡 Уменьши порог до 0.59
```

Открой `config.py` и исправь:

```python
THRESHOLDS = {
    "upgrade_arrow": 0.59,  # Было 0.72
    "icon_upgrades": 0.59,  # Если тоже низкий
}
```

### Шаг 5: Запусти бота

```bash
python3 run.py
```

Теперь увидишь:

```
🔍 StationUpgrader: Ищу upgrade_arrow...
DEBUG| Vision: Best match: scale=0.50, confidence=0.85
🎯 Найдено 3 стрелок апгрейда на экране!
🏪 Апгрейжу станцию...
✅ Апгрейд завершен
```

---

## 📊 ЧТО ПОКАЖЕТ ДИАГНОСТИКА:

### Итоговая статистика:

```
📊 ИТОГОВАЯ СТАТИСТИКА
Всего шаблонов: 13
✅ Найдено: 10
❌ Не найдено: 3

⚠️  ПРОБЛЕМНЫЕ ШАБЛОНЫ:
   - upgrade_arrow: confidence 0.6543 (порог 0.72, scale 0.50)
     💡 Уменьши порог до 0.59
   - btn_renovate: confidence 0.6123 (порог 0.75, scale 0.50)
     💡 Уменьши порог до 0.55

📊 АНАЛИЗ МАСШТАБОВ:
   Найденные шаблоны по масштабам:
      Scale 0.50x: 8 шаблонов
      Scale 1.00x: 2 шаблона
      
   ⚠️  ОБНАРУЖЕН RETINA ДИСПЛЕЙ!
      Шаблоны найдены на масштабе 0.5x
      Это значит что шаблоны 2x размер экрана
      Multi-scale matching КРИТИЧНО для твоей системы!
```

---

## 🎯 БЫСТРАЯ ДИАГНОСТИКА:

### Ожидаемый результат на Retina:

- ✅ Большинство шаблонов найдено на **scale 0.5**
- ✅ Confidence > 0.70 для большинства
- ⚠️ Некоторые могут быть немного ниже порога

### Что делать:

1. **Если Scale 0.5** → Retina подтвержден ✅
2. **Если confidence > порог** → Всё ОК ✅
3. **Если confidence < порог** → Уменьши порог в config.py
4. **Если вообще не находит** → Элемент не на экране (скроллни игру)

---

## 🔧 ЕСЛИ НИЧЕГО НЕ НАХОДИТСЯ:

### Проверь GAME_REGION в config.py:

```python
GAME_REGION = (x, y, width, height)  # Координаты окна игры
```

**Как проверить:**
```bash
# Сделай скриншот и посмотри размер
python3 -c "from core.vision import Vision; v = Vision(); v.take_screenshot(); print('Screenshot saved')"
# Открой debug_screenshot.png - видно ли игру?
```

---

## 📁 СОЗДАННЫЕ ФАЙЛЫ:

После `python3 debug_vision.py`:

1. **debug_screenshot.png** - Скриншот игры (что видит бот)
2. **debug_output.png** - С прямоугольниками (что нашел бот)

---

## ⚙️ ТЕХНИЧЕСКИЕ ДЕТАЛИ:

### Что изменено:

1. **config.py:**
   ```python
   VISION_SCALES = (0.5, 0.6, 0.75, 0.9, 1.0, 1.1, 1.25, 1.5, 2.0)
   # Было: (0.9, 1.0, 1.1) - слишком узко!
   ```

2. **core/vision.py:**
   - Улучшен multi-scale для `find_template`
   - Добавлен multi-scale для `find_all_templates`
   - Логирование лучшего scale и confidence

3. **debug_vision.py:** (НОВЫЙ)
   - Тестирует ВСЕ шаблоны
   - Показывает confidence для каждого scale
   - Сохраняет визуализацию

---

## ✅ ЧЕКЛИСТ:

- [ ] Запустил `python3 debug_vision.py`
- [ ] Посмотрел терминал - какие scale работают
- [ ] Открыл `debug_output.png` - увидел прямоугольники
- [ ] Если нужно - уменьшил пороги в `config.py`
- [ ] Запустил `python3 run.py` - проверил работает ли

---

## 🚀 НАЧНИ ПРЯМО СЕЙЧАС:

```bash
cd /Users/kendirov/App/EatV2
python3 debug_vision.py
```

**Смотри терминал и debug_output.png - увидишь ВСЁ что происходит! 🎉**

---

## 💬 ОБРАТНАЯ СВЯЗЬ:

После запуска диагностики скажи:

**"Посмотри в терминал"** - и покажи результаты!

Я увижу:
- Какие шаблоны найдены/не найдены
- Какие масштабы работают (Retina?)
- Какие пороги нужно изменить

**ЗАПУСКАЙ ДИАГНОСТИКУ! 🔍**
