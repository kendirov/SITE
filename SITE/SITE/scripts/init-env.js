/**
 * Environment Initialization Script
 * Reads API token from ./API file and creates .env.local for Vite
 * 
 * Security: This runs before Vite starts, keeping the token server-side during dev
 */

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { resolve, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const rootDir = resolve(__dirname, '..');

const API_FILE_PATH = resolve(rootDir, 'API');
const ENV_LOCAL_PATH = resolve(rootDir, '.env.local');

function initEnv() {
  console.log('üîê Initializing MOEX AlgoPack authentication...\n');

  // Check if API file exists
  if (!existsSync(API_FILE_PATH)) {
    console.error('‚ùå ERROR: API file not found!');
    console.error(`   Expected location: ${API_FILE_PATH}`);
    console.error('\nüìù Please create the API file with your MOEX AlgoPack token:');
    console.error('   1. Create a file named "API" (no extension) in the root directory');
    console.error('   2. Paste your AlgoPack authentication token');
    console.error('   3. Save and run npm run dev again\n');
    process.exit(1);
  }

  try {
    // Read token from API file
    const token = readFileSync(API_FILE_PATH, 'utf-8').trim();

    if (!token) {
      console.error('‚ùå ERROR: API file is empty!');
      console.error('   Please add your MOEX AlgoPack token to the API file\n');
      process.exit(1);
    }

    // Validate token format (basic check)
    if (token.length < 10) {
      console.warn('‚ö†Ô∏è  WARNING: Token seems too short. Please verify it\'s correct.');
    }

    // Create .env.local content
    const envContent = `# Auto-generated by scripts/init-env.js
# DO NOT COMMIT THIS FILE - IT CONTAINS YOUR SECRET TOKEN!
# Generated: ${new Date().toISOString()}

# MOEX AlgoPack Authentication Token
VITE_MOEX_AUTH_TOKEN=${token}

# AlgoPack API Configuration
VITE_MOEX_API_BASE=/api/moex
VITE_MOEX_API_TIMEOUT=30000
`;

    // Write to .env.local
    writeFileSync(ENV_LOCAL_PATH, envContent, 'utf-8');

    console.log('‚úÖ Environment configured successfully!');
    console.log(`   Token loaded: ${token.substring(0, 10)}...${token.substring(token.length - 4)}`);
    console.log(`   Config file: .env.local`);
    console.log('\nüöÄ Starting Vite dev server...\n');

  } catch (error) {
    console.error('‚ùå ERROR: Failed to initialize environment');
    console.error(`   ${error.message}\n`);
    process.exit(1);
  }
}

// Run initialization
initEnv();
